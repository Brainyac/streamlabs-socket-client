{"version":3,"sources":["../../src/streamlabs.js"],"names":["StreamlabsClient","options","Set","token","emitTests","rawEvents","Error","Array","isArray","Object","assign","baseURL","client","autoConnect","forceNode","forceJSONP","hookEventListeners","createClient","connect","disconnect","event","idTable","has","event_id","add","message","type","isTest","emit","isResub","sub_type","months","Number","formattedMonths","amount","formattedAmount","formatted_amount","toString","currency","viewers","formattedViewers","on","forEach","handleEvent","for","error","eventName","hookRawEventListener","data"],"mappings":"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","file":"streamlabs.js","sourcesContent":["import EventEmitter from 'eventemitter3';\nimport ioClient from 'socket.io-client';\n\nimport { removeCommas, removeNonNumeric } from './helpers';\n\nclass StreamlabsClient extends EventEmitter {\n  baseURL = 'https://sockets.streamlabs.com/?token=';\n  token = null;\n  client = null;\n  rawEvents = [];\n  idTable = new Set();\n\n  constructor (options) {\n    super();\n\n    const {\n      token,\n      emitTests,\n      rawEvents,\n    } = options;\n\n    if (!token || typeof token !== 'string') {\n      throw new Error('StreamlabsClient constructor expected \\'token\\' to be a string with length longer than 0.');\n    }\n\n    if (Array.isArray(rawEvents)) {\n      this.rawEvents = rawEvents;\n    }\n\n    Object.assign(this, {\n      token,\n      emitTests: !!emitTests,\n    });\n  }\n\n  createClient () {\n    const {\n      baseURL,\n      token,\n      client,\n    } = this;\n\n    if (client) {\n      return;\n    }\n\n    this.client = ioClient(baseURL + token, {\n      autoConnect: false,\n      // transports: ['websocket'],\n      forceNode: true,\n      forceJSONP: false,\n      // debug: true,\n    });\n\n    this.hookEventListeners();\n  }\n\n  connect () {\n    if (!this.client) {\n      this.createClient();\n    }\n\n    this.client.connect();\n  }\n\n  disconnect () {\n    if (this.client) {\n      this.client.disconnect();\n    }\n  }\n\n  handleEvent (event) {\n    if (this.idTable.has(event.event_id)) {\n      return;\n    }\n\n    this.idTable.add(event.event_id);\n\n    const { message, type } = event;\n\n    if (!this.emitTests && message && message.isTest) {\n      return;\n    }\n\n    const isTest = !!message.isTest;\n\n    switch (type) {\n      case 'follow': {\n        this.emit('follow', {\n          ...message,\n          isTest,\n        });\n\n        break;\n      }\n\n      case 'subscription': {\n        const isResub = !!message.sub_type && message.sub_type === 'resub';\n\n        if (isResub) {\n          this.emit('resubscription', {\n            ...message,\n            months: Number(removeCommas(message.months)) || 0,\n            formattedMonths: message.months,\n            isTest,\n          });\n        } else {\n          this.emit('subscription', {\n            ...message,\n            isTest,\n          });\n        }\n\n        break;\n      }\n\n      case 'donation': {\n        this.emit('donation', {\n          ...message,\n          amount: Number(removeNonNumeric(message.amount)),\n          formattedAmount: (message.formattedAmount || message.formatted_amount || '').toString(),\n          currency: message.currency || 'USD',\n          isTest,\n        });\n\n        break;\n      }\n\n      case 'host': {\n        this.emit('host', {\n          ...message,\n          viewers: Number(removeNonNumeric(message.viewers)),\n          formattedViewers: message.viewers.toString(),\n          isTest,\n        });\n\n        break;\n      }\n\n      case 'bits': {\n        this.emit('bits', {\n          ...message,\n          amount: Number(removeCommas(message.amount)) || 0,\n          formattedAmount: message.amount.toString(),\n          isTest: !!message.isTest,\n        });\n\n        break;\n      }\n\n      default: {\n        this.emit(type, {\n          ...message,\n          isTest,\n        });\n\n        break;\n      }\n    }\n  }\n\n  hookEventListeners () {\n    this.client.on('event', (event) => {\n      try {\n        if (Array.isArray(event.message)) {\n          event.message.forEach((message) => {\n            this.handleEvent({\n              type: event.type,\n              event_id: event.event_id,\n              for: event.for || '',\n              message,\n            });\n          });\n        }\n      } catch (error) {\n        this.emit('error', error);\n      }\n    });\n\n    this.rawEvents.forEach((eventName) => {\n      this.hookRawEventListener(eventName);\n    });\n  }\n\n  hookRawEventListener (eventName) {\n    this.client.on(eventName, (...data) => {\n      this.emit(eventName, ...data);\n    });\n  }\n}\n\nexport default StreamlabsClient;\n"]}